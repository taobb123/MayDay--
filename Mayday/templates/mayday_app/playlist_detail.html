{% extends 'mayday_app/base.html' %}

{% block title %}{{ playlist.name }} - 五月天音乐收藏系统{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4 position-relative">
        <div>
            <h2><i class="bi bi-music-note-list"></i> {{ playlist.name }}</h2>
            <p class="text-muted mb-0">
                <i class="bi bi-music-note-beamed"></i> {{ playlist_songs.count }} 首歌曲
                <span class="ms-3"><i class="bi bi-calendar"></i> {{ playlist.created_at|date:"Y年m月d日" }}</span>
            </p>
        </div>
        <div class="d-flex align-items-center gap-2">
            <button class="btn btn-primary" onclick="editPlaylist({{ playlist.id }}, '{{ playlist.name }}')">
                <i class="bi bi-pencil"></i> 编辑
            </button>
            <button class="btn btn-outline-secondary" onclick="location.href='{% url 'playlist_list' %}'" title="关闭">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
    </div>
    
    {% if playlist_songs %}
    <div class="table-responsive">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>#</th>
                    <th>歌曲</th>
                    <th>艺术家</th>
                    <th>专辑</th>
                    <th>时长</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                {% for playlist_song in playlist_songs %}
                <tr data-song-id="{{ playlist_song.song.id }}" 
                    data-song-title="{{ playlist_song.song.title|escapejs }}" 
                    data-song-artist="{{ playlist_song.song.artist|escapejs }}" 
                    data-song-url="{% url 'play_song' playlist_song.song.id %}">
                    <td>{{ forloop.counter }}</td>
                    <td>{{ playlist_song.song.title }}</td>
                    <td>{{ playlist_song.song.artist }}</td>
                    <td>{{ playlist_song.song.album.name|default:"-" }}</td>
                    <td>
                        {% if playlist_song.song.duration %}
                        {{ playlist_song.song.duration|floatformat:0 }}秒
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td>
                        <div class="btn-group" role="group">
                            {% if playlist_song.song.file_path or playlist_song.song.original_path %}
                            <button class="btn btn-sm btn-primary" 
                                    onclick="playSongFromPlaylist('{% url 'play_song' playlist_song.song.id %}', '{{ playlist_song.song.title|escapejs }}', '{{ playlist_song.song.artist|escapejs }}', {{ playlist_song.song.id }}, {{ forloop.counter0 }})">
                                <i class="bi bi-play-fill"></i> 播放
                            </button>
                            {% endif %}
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                    <i class="bi bi-list-ul"></i> 移动到
                                </button>
                                <ul class="dropdown-menu" id="moveMenu{{ playlist_song.song.id }}">
                                    <li><a class="dropdown-item" href="#" onclick="moveSong({{ playlist.id }}, {{ playlist_song.song.id }})">选择歌单...</a></li>
                                </ul>
                            </div>
                            <button class="btn btn-sm btn-outline-danger" 
                                    onclick="removeFromPlaylist({{ playlist.id }}, {{ playlist_song.song.id }}, '{{ playlist_song.song.title }}')">
                                <i class="bi bi-trash"></i> 移除
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="text-center py-5">
        <i class="bi bi-music-note-list" style="font-size: 4rem; color: #ccc;"></i>
        <p class="text-muted mt-3">这个歌单还没有歌曲</p>
    </div>
    {% endif %}
</div>

<!-- 编辑歌单模态框 -->
<div class="modal fade" id="playlistModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">编辑歌单</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="playlistForm">
                    <div class="mb-3">
                        <label for="playlistName" class="form-label">歌单名称</label>
                        <input type="text" class="form-control" id="playlistName" required>
                        <input type="hidden" id="playlistId" value="{{ playlist.id }}">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="savePlaylist()">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 选择目标歌单模态框 -->
<div class="modal fade" id="targetPlaylistModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">选择目标歌单</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="targetPlaylistList"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            </div>
        </div>
    </div>
</div>

<script>
function editPlaylist(id, name) {
    document.getElementById('playlistName').value = name;
    document.getElementById('playlistId').value = id;
    const modal = new bootstrap.Modal(document.getElementById('playlistModal'));
    modal.show();
}

function savePlaylist() {
    const name = document.getElementById('playlistName').value.trim();
    const id = document.getElementById('playlistId').value;
    
    if (!name) {
        alert('请输入歌单名称');
        return;
    }
    
    fetch(`/api/playlists/${id}/`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ name: name })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
        } else {
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('保存失败');
    });
}

function removeFromPlaylist(playlistId, songId, songTitle) {
    if (!confirm(`确定要从歌单中移除"${songTitle}"吗？`)) {
        return;
    }
    
    fetch(`/api/playlists/${playlistId}/remove_song/`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ song_id: songId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
        } else {
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('移除失败');
    });
}

function moveSong(playlistId, songId) {
    // 加载所有歌单
    fetch('/api/playlists/')
        .then(response => response.json())
        .then(playlists => {
            const listDiv = document.getElementById('targetPlaylistList');
            listDiv.innerHTML = '';
            
            if (playlists.length === 0) {
                listDiv.innerHTML = '<p class="text-muted">没有其他歌单</p>';
                return;
            }
            
            playlists.forEach(playlist => {
                if (playlist.id !== playlistId) {
                    const btn = document.createElement('button');
                    btn.className = 'btn btn-outline-primary w-100 mb-2';
                    btn.textContent = `${playlist.name} (${playlist.song_count}首)`;
                    btn.onclick = () => {
                        performMoveSong(playlistId, songId, playlist.id);
                    };
                    listDiv.appendChild(btn);
                }
            });
            
            const modal = new bootstrap.Modal(document.getElementById('targetPlaylistModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('加载歌单失败');
        });
}

function performMoveSong(playlistId, songId, targetPlaylistId) {
    fetch(`/api/playlists/${playlistId}/move_song/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            song_id: songId,
            target_playlist_id: targetPlaylistId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
        } else {
            bootstrap.Modal.getInstance(document.getElementById('targetPlaylistModal')).hide();
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('移动失败');
    });
}

// 从歌单播放歌曲，同时加载整个歌单到播放器
function playSongFromPlaylist(songUrl, songTitle, artist, songId, songIndex) {
    // 获取页面上所有歌曲信息（从data属性获取，更可靠）
    const songRows = document.querySelectorAll('tbody tr[data-song-id]');
    const playlistSongs = [];
    
    songRows.forEach((row) => {
        const songIdAttr = row.getAttribute('data-song-id');
        const songTitleAttr = row.getAttribute('data-song-title');
        const songArtistAttr = row.getAttribute('data-song-artist');
        const songUrlAttr = row.getAttribute('data-song-url');
        
        if (songIdAttr && songTitleAttr && songArtistAttr && songUrlAttr) {
            playlistSongs.push({
                url: songUrlAttr,
                title: songTitleAttr,
                artist: songArtistAttr,
                id: parseInt(songIdAttr)
            });
        }
    });
    
    // 如果从data属性获取失败，尝试从onclick解析（备用方案）
    if (playlistSongs.length === 0) {
        const playButtons = document.querySelectorAll('button[onclick*="playSongFromPlaylist"]');
        playButtons.forEach((button) => {
            const onclick = button.getAttribute('onclick');
            const match = onclick.match(/playSongFromPlaylist\('([^']+)',\s*'([^']+)',\s*'([^']+)',\s*(\d+),\s*(\d+)\)/);
            if (match) {
                playlistSongs.push({
                    url: match[1],
                    title: match[2].replace(/\\'/g, "'").replace(/\\"/g, '"'),
                    artist: match[3].replace(/\\'/g, "'").replace(/\\"/g, '"'),
                    id: parseInt(match[4])
                });
            }
        });
    }
    
    // 如果找到了歌曲列表，设置到播放器
    if (playlistSongs.length > 0) {
        if (typeof window.setPlaylist === 'function') {
            window.setPlaylist(playlistSongs, songIndex);
        } else if (typeof window.playlist !== 'undefined') {
            // 如果setPlaylist函数不存在，直接设置全局playlist变量
            window.playlist = playlistSongs;
            window.currentIndex = songIndex;
            // 更新随机播放列表
            if (typeof window.updateShuffledPlaylist === 'function') {
                window.updateShuffledPlaylist();
            }
        }
    }
    
    // 播放选中的歌曲
    if (typeof window.playSong === 'function') {
        window.playSong(songUrl, songTitle, artist, songId);
    } else {
        // 如果playSong函数不存在，直接调用
        playSong(songUrl, songTitle, artist, songId);
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}

