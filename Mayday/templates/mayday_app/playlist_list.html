{% extends 'mayday_app/base.html' %}

{% block title %}我的歌单 - 五月天音乐收藏系统{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-music-note-list"></i> 我的歌单</h2>
        <div class="d-flex align-items-center gap-2">
            <button class="btn btn-primary" onclick="showCreatePlaylistModal()">
                <i class="bi bi-plus-circle"></i> 创建歌单
            </button>
            <button class="btn btn-outline-secondary" onclick="location.href='{% url 'index' %}'" title="关闭">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
    </div>
    
    {% if playlists %}
    <div class="row">
        {% for playlist in playlists %}
        <div class="col-md-4 mb-4">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">
                        <a href="{% url 'playlist_detail' playlist.id %}" class="text-decoration-none">
                            {{ playlist.name }}
                        </a>
                    </h5>
                    <p class="text-muted mb-2">
                        <i class="bi bi-music-note-beamed"></i> {{ playlist.songs.count }} 首歌曲
                    </p>
                    <p class="text-muted small mb-3">
                        <i class="bi bi-calendar"></i> {{ playlist.created_at|date:"Y年m月d日" }}
                    </p>
                    <div class="btn-group" role="group">
                        <a href="{% url 'playlist_detail' playlist.id %}" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-eye"></i> 查看
                        </a>
                        <button class="btn btn-sm btn-success" onclick="showAddSongModal({{ playlist.id }}, '{{ playlist.name }}')">
                            <i class="bi bi-plus-circle"></i> 添加歌曲
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="editPlaylist({{ playlist.id }}, '{{ playlist.name }}')">
                            <i class="bi bi-pencil"></i> 编辑
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deletePlaylist({{ playlist.id }}, '{{ playlist.name }}')">
                            <i class="bi bi-trash"></i> 删除
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-5">
        <i class="bi bi-music-note-list" style="font-size: 4rem; color: #ccc;"></i>
        <p class="text-muted mt-3">还没有创建任何歌单</p>
        <button class="btn btn-primary" onclick="showCreatePlaylistModal()">
            <i class="bi bi-plus-circle"></i> 创建第一个歌单
        </button>
    </div>
    {% endif %}
</div>

<!-- 添加歌曲模态框 -->
<div class="modal fade" id="addSongModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addSongModalTitle">添加歌曲</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="songSearchInput" class="form-label">搜索歌曲</label>
                    <input type="text" class="form-control" id="songSearchInput" placeholder="输入歌曲名称或艺术家名称...">
                    <small class="text-muted">至少输入2个字符开始搜索</small>
                </div>
                <div id="songSearchResults" style="max-height: 400px; overflow-y: auto;">
                    <p class="text-muted text-center">请输入关键词搜索歌曲</p>
                </div>
                <input type="hidden" id="currentPlaylistId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<!-- 创建/编辑歌单模态框 -->
<div class="modal fade" id="playlistModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="playlistModalTitle">创建歌单</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="playlistForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="playlistName" class="form-label">歌单名称</label>
                        <input type="text" class="form-control" id="playlistName" required>
                        <input type="hidden" id="playlistId">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="savePlaylist()">保存</button>
            </div>
        </div>
    </div>
</div>

<script>
function showCreatePlaylistModal() {
    document.getElementById('playlistModalTitle').textContent = '创建歌单';
    document.getElementById('playlistName').value = '';
    document.getElementById('playlistId').value = '';
    const modal = new bootstrap.Modal(document.getElementById('playlistModal'));
    modal.show();
}

function editPlaylist(id, name) {
    document.getElementById('playlistModalTitle').textContent = '编辑歌单';
    document.getElementById('playlistName').value = name;
    document.getElementById('playlistId').value = id;
    const modal = new bootstrap.Modal(document.getElementById('playlistModal'));
    modal.show();
}

function savePlaylist() {
    const name = document.getElementById('playlistName').value.trim();
    const id = document.getElementById('playlistId').value;
    
    if (!name) {
        alert('请输入歌单名称');
        document.getElementById('playlistName').focus();
        return;
    }
    
    // 检查名称长度
    if (name.length > 200) {
        alert('歌单名称不能超过200个字符');
        document.getElementById('playlistName').focus();
        return;
    }
    
    // 使用新的API端点，确保返回JSON
    const url = id ? `/api/playlists/${id}/update/` : '/api/playlists/create/';
    const method = id ? 'PUT' : 'POST';
    const data = { name: name };
    
    const csrfToken = getCookie('csrftoken');
    if (!csrfToken) {
        alert('CSRF token未找到，请刷新页面后重试');
        return;
    }
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            'X-CSRFToken': csrfToken
        },
        credentials: 'same-origin',
        body: JSON.stringify(data)
    })
    .then(async response => {
        // 先获取响应文本
        const text = await response.text();
        
        // 检查响应类型
        const contentType = response.headers.get('content-type') || '';
        const isJson = contentType.includes('application/json');
        
        if (!isJson) {
            console.error('非JSON响应:', text.substring(0, 500));
            if (response.status === 403) {
                throw new Error('CSRF验证失败，请刷新页面后重试');
            } else if (response.status === 401) {
                throw new Error('请先登录');
            } else {
                throw new Error(`服务器返回了非JSON响应 (状态码: ${response.status})`);
            }
        }
        
        // 解析JSON
        let jsonData;
        try {
            jsonData = JSON.parse(text);
        } catch (e) {
            console.error('JSON解析失败:', text.substring(0, 500));
            throw new Error('服务器响应格式错误');
        }
        
        if (!response.ok) {
            // 处理错误
            const errorMsg = jsonData.error || jsonData.message || `操作失败 (状态码: ${response.status})`;
            throw new Error(errorMsg);
        }
        return jsonData;
    })
    .then(data => {
        // 静默处理，不显示成功消息
        // 关闭模态框
        const modal = bootstrap.Modal.getInstance(document.getElementById('playlistModal'));
        if (modal) {
            modal.hide();
        }
        location.reload();
    })
    .catch(error => {
        console.error('Error:', error);
        console.error('Error stack:', error.stack);
        let errorMsg = '操作失败';
        if (error.message) {
            errorMsg = error.message;
        }
        alert(errorMsg);
    });
}

function deletePlaylist(id, name) {
    if (!confirm(`确定要删除歌单"${name}"吗？`)) {
        return;
    }
    
    fetch(`/api/playlists/${id}/delete/`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        credentials: 'same-origin'
    })
    .then(async response => {
        // 确保响应是JSON
        const contentType = response.headers.get('content-type') || '';
        if (!contentType.includes('application/json')) {
            throw new Error('服务器返回了非JSON响应');
        }
        
        const jsonData = await response.json();
        
        if (response.ok) {
            location.reload();
        } else {
            alert(jsonData.error || '删除失败');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert(error.message || '删除失败');
    });
}

let songSearchTimeout = null;

function showAddSongModal(playlistId, playlistName) {
    document.getElementById('addSongModalTitle').textContent = `添加歌曲到"${playlistName}"`;
    document.getElementById('currentPlaylistId').value = playlistId;
    document.getElementById('songSearchInput').value = '';
    document.getElementById('songSearchResults').innerHTML = '<p class="text-muted text-center">请输入关键词搜索歌曲</p>';
    const modal = new bootstrap.Modal(document.getElementById('addSongModal'));
    modal.show();
    
    // 聚焦搜索框
    setTimeout(() => {
        const searchInput = document.getElementById('songSearchInput');
        if (searchInput) {
            searchInput.focus();
        }
    }, 300);
}

// 初始化搜索功能 - 使用事件委托，确保在模态框显示后也能工作
document.addEventListener('DOMContentLoaded', function() {
    // 使用事件委托，监听整个文档
    document.addEventListener('input', function(e) {
        if (e.target && e.target.id === 'songSearchInput') {
            const query = e.target.value.trim();
            
            clearTimeout(songSearchTimeout);
            
            if (query.length < 2) {
                document.getElementById('songSearchResults').innerHTML = '<p class="text-muted text-center">请输入至少2个字符</p>';
                return;
            }
            
            songSearchTimeout = setTimeout(() => {
                performSongSearch(query);
            }, 500);
        }
    });
    
    // 回车搜索
    document.addEventListener('keypress', function(e) {
        if (e.target && e.target.id === 'songSearchInput' && e.key === 'Enter') {
            e.preventDefault();
            const query = e.target.value.trim();
            if (query.length >= 2) {
                clearTimeout(songSearchTimeout);
                performSongSearch(query);
            }
        }
    });
});

function performSongSearch(query) {
    const resultsDiv = document.getElementById('songSearchResults');
    resultsDiv.innerHTML = '<p class="text-muted text-center"><i class="bi bi-hourglass-split"></i> 搜索中...</p>';
    
    fetch(`/api/search/?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            if (data.results && data.results.length > 0) {
                let html = '<table class="table table-hover table-sm">';
                html += '<thead><tr><th>歌曲</th><th>艺术家</th><th>专辑</th><th>操作</th></tr></thead>';
                html += '<tbody>';
                
                data.results.forEach(song => {
                    html += '<tr>';
                    html += `<td>${escapeHtml(song.title || '-')}</td>`;
                    html += `<td>${escapeHtml(song.artist || '-')}</td>`;
                    html += `<td>${escapeHtml(song.album?.name || '-')}</td>`;
                    html += '<td>';
                    html += `<button class="btn btn-sm btn-primary" onclick="addSongToPlaylist(${song.id}, '${escapeHtml(song.title)}')">`;
                    html += '<i class="bi bi-plus-circle"></i> 添加';
                    html += '</button>';
                    html += '</td>';
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
                resultsDiv.innerHTML = html;
            } else {
                resultsDiv.innerHTML = '<p class="text-muted text-center">未找到相关歌曲</p>';
            }
        })
        .catch(error => {
            console.error('搜索错误:', error);
            resultsDiv.innerHTML = '<p class="text-danger text-center">搜索失败，请重试</p>';
        });
}

function addSongToPlaylist(songId, songTitle) {
    const playlistId = document.getElementById('currentPlaylistId')?.value;
    
    if (!playlistId) {
        console.error('addSongToPlaylist: 歌单ID未找到');
        alert('歌单ID未找到');
        return;
    }
    
    // 确保是数字类型
    const playlistIdNum = parseInt(playlistId);
    const songIdNum = parseInt(songId);
    
    if (isNaN(playlistIdNum) || isNaN(songIdNum)) {
        console.error('addSongToPlaylist: 参数类型错误', { playlistId: playlistIdNum, songId: songIdNum });
        alert('参数错误：歌单ID或歌曲ID必须是数字');
        return;
    }
    
    const csrfToken = getCookie('csrftoken');
    if (!csrfToken) {
        alert('CSRF token未找到，请刷新页面后重试');
        return;
    }
    
    console.log('添加歌曲到歌单:', { playlistId: playlistIdNum, songId: songIdNum });
    
    fetch(`/api/playlists/${playlistIdNum}/add_song/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            'X-CSRFToken': csrfToken
        },
        credentials: 'same-origin',
        body: JSON.stringify({ song_id: songIdNum })
    })
    .then(async response => {
        const text = await response.text();
        const contentType = response.headers.get('content-type') || '';
        const isJson = contentType.includes('application/json');
        
        if (!isJson) {
            throw new Error('服务器返回了非JSON响应');
        }
        
        const jsonData = JSON.parse(text);
        
        if (!response.ok) {
            throw new Error(jsonData.error || '添加失败');
        }
        
        return jsonData;
    })
    .then(data => {
        // 静默处理，不显示成功消息
        // 刷新页面
        location.reload();
    })
    .catch(error => {
        console.error('Error:', error);
        alert(error.message || '添加失败');
    });
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    // 如果cookie中没有，尝试从隐藏的csrf token input中获取
    if (!cookieValue && name === 'csrftoken') {
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfInput) {
            cookieValue = csrfInput.value;
        }
    }
    return cookieValue;
}
</script>
{% endblock %}

