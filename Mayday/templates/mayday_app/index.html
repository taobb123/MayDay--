{% extends 'mayday_app/base.html' %}

{% block content %}
<div class="container-fluid" data-user-authenticated="{% if user.is_authenticated %}true{% else %}false{% endif %}">
    <!-- 搜索和操作按钮 -->
    <div class="mb-4 d-flex justify-content-between align-items-center">
        <div class="flex-grow-1 me-3">
            <div class="input-group">
                <input type="text" class="form-control" id="searchInput" placeholder="搜索歌曲或作者..." onkeyup="handleSearchKeyup(event)">
                <button class="btn btn-outline-primary" onclick="performSearch()">
                    <i class="bi bi-search"></i> 搜索
                </button>
            </div>
            <div id="searchResults" class="mt-3" style="display: none;">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>搜索结果</span>
                        <button class="btn btn-sm btn-secondary" onclick="closeSearchResults()">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="searchResultsContent"></div>
                    </div>
                </div>
            </div>
            {% if user.is_authenticated %}
            <div class="mt-2">
                <a href="{% url 'playlist_list' %}" class="text-decoration-none">
                    <i class="bi bi-music-note-list"></i> 我的歌单
                </a>
            </div>
            {% endif %}
        </div>
        <div>
            <button class="btn btn-scan" onclick="scanMusic()">
                <i class="bi bi-folder2-open"></i> 扫描音乐
            </button>
        </div>
    </div>
    
    <!-- 专辑展示 -->
    <div class="mb-5">
        <h2 class="mb-4"><i class="bi bi-vinyl"></i> 专辑</h2>
        <div class="album-grid">
            {% for album in albums %}
            <a href="{% url 'album_detail' album.id %}" class="album-card" style="text-decoration: none; color: inherit; display: block;">
                {% if album.cover_image %}
                <img src="{{ album.cover_image.url }}" alt="{{ album.name }}" class="album-cover">
                {% else %}
                <div class="album-cover d-flex align-items-center justify-content-center text-white">
                    <i class="bi bi-music-note-beamed" style="font-size: 4rem;"></i>
                </div>
                {% endif %}
                <div class="album-info">
                    <h5>{{ album.name }}</h5>
                    <p class="text-muted mb-1">{{ album.release_date|date:"Y年m月d日" }}</p>
                    <small class="text-muted">{{ album.songs.count }} 首歌曲</small>
                </div>
            </a>
            {% empty %}
            <div class="col-12 text-center text-muted">
                <p>暂无专辑，请先扫描音乐文件</p>
            </div>
            {% endfor %}
        </div>
        
        <!-- 分页导航 -->
        {% if albums.has_other_pages %}
        <nav aria-label="专辑分页" class="mt-4">
            <ul class="pagination justify-content-center">
                {% if albums.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?album_page=1{% if songs.number > 1 %}&song_page={{ songs.number }}{% endif %}">&laquo; 首页</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?album_page={{ albums.previous_page_number }}{% if songs.number > 1 %}&song_page={{ songs.number }}{% endif %}">上一页</a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <span class="page-link">&laquo; 首页</span>
                </li>
                <li class="page-item disabled">
                    <span class="page-link">上一页</span>
                </li>
                {% endif %}
                
                <li class="page-item active">
                    <span class="page-link">
                        第 {{ albums.number }} 页，共 {{ albums.paginator.num_pages }} 页
                    </span>
                </li>
                
                {% if albums.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?album_page={{ albums.next_page_number }}{% if songs.number > 1 %}&song_page={{ songs.number }}{% endif %}">下一页</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?album_page={{ albums.paginator.num_pages }}{% if songs.number > 1 %}&song_page={{ songs.number }}{% endif %}">末页 &raquo;</a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <span class="page-link">下一页</span>
                </li>
                <li class="page-item disabled">
                    <span class="page-link">末页 &raquo;</span>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
    
    <!-- 时间线 -->
    <div class="mb-5">
        <h2 class="mb-4"><i class="bi bi-clock-history"></i> 时间隧道</h2>
        <div class="timeline">
            {% for item in timeline_data %}
            <div class="timeline-item {{ item.type }}">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-2">
                            {% if item.type == 'album' %}
                            <i class="bi bi-vinyl-fill text-primary me-2"></i>
                            {% elif item.type == 'tour' %}
                            <i class="bi bi-music-player-fill text-warning me-2"></i>
                            {% elif item.type == 'quote' %}
                            <i class="bi bi-chat-quote-fill text-success me-2"></i>
                            {% elif item.type == 'image' %}
                            <i class="bi bi-image-fill text-danger me-2"></i>
                            {% endif %}
                            <h5 class="mb-0">{{ item.title }}</h5>
                        </div>
                        <p class="text-muted mb-2">
                            <i class="bi bi-calendar3"></i> {{ item.date|date:"Y年m月d日" }}
                        </p>
                        {% if item.type == 'album' and item.content.cover_image %}
                        <img src="{{ item.content.cover_image }}" alt="{{ item.title }}" 
                             class="img-fluid rounded mb-2" style="max-width: 200px;">
                        {% endif %}
                        {% if item.type == 'quote' %}
                        <blockquote class="blockquote">
                            <p>{{ item.content.text }}</p>
                            {% if item.content.author %}
                            <footer class="blockquote-footer">{{ item.content.author }}</footer>
                            {% endif %}
                        </blockquote>
                        {% endif %}
                        {% if item.type == 'image' and item.content.image_url %}
                        <img src="{{ item.content.image_url }}" alt="{{ item.title }}" 
                             class="img-fluid rounded mb-2" style="max-height: 300px;">
                        {% endif %}
                        {% if item.content.description %}
                        <p>{{ item.content.description|truncatewords:30 }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="text-center text-muted">
                <p>时间线为空，请添加内容</p>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- 最近歌曲 -->
    <div class="mb-5">
        <h2 class="mb-4"><i class="bi bi-music-note-list"></i> 歌曲列表</h2>
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>歌曲</th>
                        <th>艺术家</th>
                        <th>专辑</th>
                        <th>时长</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for song in songs %}
                    <tr>
                        <td>{{ songs_start_index|add:forloop.counter0 }}</td>
                        <td>{{ song.title }}</td>
                        <td>{{ song.artist }}</td>
                        <td>{{ song.album.name|default:"-" }}</td>
                        <td>
                            {% if song.duration %}
                            {{ song.duration|floatformat:0 }}秒
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                {% if song.file_path or song.original_path %}
                                <button class="btn btn-sm btn-primary play-song-btn" 
                                        data-play-url="{% url 'play_song' song.id %}"
                                        data-song-title="{{ song.title|escapejs }}"
                                        data-song-artist="{{ song.artist|escapejs }}"
                                        data-song-id="{{ song.id }}">
                                    <i class="bi bi-play-fill"></i> 播放
                                </button>
                                {% endif %}
                                <button class="btn btn-sm btn-outline-info add-temp-list-btn" 
                                        data-song-id="{{ song.id }}"
                                        data-song-title="{{ song.title|escapejs }}"
                                        data-song-artist="{{ song.artist|escapejs }}"
                                        data-play-url="{% url 'play_song' song.id %}">
                                    <i class="bi bi-plus-circle"></i> 临时列表
                                </button>
                                {% if user.is_authenticated %}
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                        <i class="bi bi-list-ul"></i> 歌单
                                    </button>
                                    <ul class="dropdown-menu playlist-menu" data-song-id="{{ song.id }}">
                                        <li><a class="dropdown-item add-to-playlist-btn" href="#">选择歌单...</a></li>
                                    </ul>
                                </div>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center text-muted">暂无歌曲</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- 歌曲分页导航 -->
        {% if songs.has_other_pages %}
        <nav aria-label="歌曲分页" class="mt-4">
            <ul class="pagination justify-content-center">
                {% if songs.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?song_page=1{% if albums.number > 1 %}&album_page={{ albums.number }}{% endif %}">&laquo; 首页</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?song_page={{ songs.previous_page_number }}{% if albums.number > 1 %}&album_page={{ albums.number }}{% endif %}">上一页</a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <span class="page-link">&laquo; 首页</span>
                </li>
                <li class="page-item disabled">
                    <span class="page-link">上一页</span>
                </li>
                {% endif %}
                
                <li class="page-item active">
                    <span class="page-link">
                        第 {{ songs.number }} 页，共 {{ songs.paginator.num_pages }} 页
                    </span>
                </li>
                
                {% if songs.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?song_page={{ songs.next_page_number }}{% if albums.number > 1 %}&album_page={{ albums.number }}{% endif %}">下一页</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?song_page={{ songs.paginator.num_pages }}{% if albums.number > 1 %}&album_page={{ albums.number }}{% endif %}">末页 &raquo;</a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <span class="page-link">下一页</span>
                </li>
                <li class="page-item disabled">
                    <span class="page-link">末页 &raquo;</span>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
</div>

<script>
// 从DOM获取用户认证状态
const container = document.querySelector('.container-fluid');
const USER_AUTHENTICATED = container && container.dataset.userAuthenticated === 'true';
let searchTimeout = null;

// 事件委托：处理播放按钮点击
document.addEventListener('click', function(e) {
    if (e.target.closest('.play-song-btn')) {
        const btn = e.target.closest('.play-song-btn');
        const playUrl = btn.dataset.playUrl;
        const title = btn.dataset.songTitle;
        const artist = btn.dataset.songArtist;
        const songId = parseInt(btn.dataset.songId);
        playSong(playUrl, title, artist, songId);
    }
    
    if (e.target.closest('.add-temp-list-btn')) {
        const btn = e.target.closest('.add-temp-list-btn');
        const songId = parseInt(btn.dataset.songId);
        const title = btn.dataset.songTitle;
        const artist = btn.dataset.songArtist;
        const playUrl = btn.dataset.playUrl;
        addToTempList(songId, title, artist, playUrl);
    }
    
    if (e.target.closest('.add-to-playlist-btn')) {
        const menu = e.target.closest('.playlist-menu');
        if (menu) {
            const songId = parseInt(menu.dataset.songId);
            addToPlaylist(songId);
        }
    }
});

function handleSearchKeyup(event) {
    if (event.key === 'Enter') {
        performSearch();
    } else {
        // 防抖：延迟搜索
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            const query = event.target.value.trim();
            if (query.length >= 2) {
                performSearch();
            }
        }, 500);
    }
}

function performSearch() {
    const query = document.getElementById('searchInput').value.trim();
    if (!query) {
        closeSearchResults();
        return;
    }
    
    fetch(`/api/search/?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            const resultsDiv = document.getElementById('searchResults');
            const contentDiv = document.getElementById('searchResultsContent');
            
            if (data.results && data.results.length > 0) {
                let html = '<table class="table table-hover">';
                html += '<thead><tr><th>歌曲</th><th>艺术家</th><th>专辑</th><th>操作</th></tr></thead>';
                html += '<tbody>';
                
                data.results.forEach(song => {
                    const titleEscaped = song.title.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    const artistEscaped = song.artist.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    html += `
                        <tr>
                            <td>${song.title}</td>
                            <td>${song.artist}</td>
                            <td>${song.album_name || '-'}</td>
                            <td>
                                <div class="btn-group" role="group">
                                    <button class="btn btn-sm btn-primary" 
                                            onclick="playSong('/play/${song.id}/', '${titleEscaped}', '${artistEscaped}', ${song.id})">
                                        <i class="bi bi-play-fill"></i> 播放
                                    </button>
                                    <button class="btn btn-sm btn-outline-info" 
                                            onclick="addToTempList(${song.id}, '${titleEscaped}', '${artistEscaped}', '/play/${song.id}/')">
                                        <i class="bi bi-plus-circle"></i> 临时列表
                                    </button>
                                    ${USER_AUTHENTICATED ? `
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                            <i class="bi bi-list-ul"></i> 歌单
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="#" onclick="addToPlaylist(${song.id})">选择歌单...</a></li>
                                        </ul>
                                    </div>
                                    ` : ''}
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                contentDiv.innerHTML = html;
                resultsDiv.style.display = 'block';
            } else {
                contentDiv.innerHTML = '<p class="text-muted text-center">没有找到相关歌曲</p>';
                resultsDiv.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Search error:', error);
            alert('搜索失败');
        });
}

function closeSearchResults() {
    document.getElementById('searchResults').style.display = 'none';
    document.getElementById('searchInput').value = '';
}

function addToPlaylist(songId) {
    // 加载所有歌单
    fetch('/api/playlists/')
        .then(response => response.json())
        .then(playlists => {
            if (playlists.length === 0) {
                if (confirm('您还没有创建任何歌单，是否现在创建？')) {
                    window.location.href = '{% url "playlist_list" %}';
                }
                return;
            }
            
            // 创建选择菜单
            let menuHtml = '';
            playlists.forEach(playlist => {
                menuHtml += `<li><a class="dropdown-item" href="#" onclick="addSongToPlaylist(${playlist.id}, ${songId})">${playlist.name} (${playlist.song_count}首)</a></li>`;
            });
            
            // 显示选择对话框
            const menuId = `playlistMenu${songId}`;
            const menu = document.getElementById(menuId);
            if (menu) {
                menu.innerHTML = menuHtml;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('加载歌单失败');
        });
}

function addSongToPlaylist(playlistId, songId) {
    fetch(`/api/playlists/${playlistId}/add_song/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ song_id: songId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
        } else {
            alert('已添加到歌单');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('添加失败');
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}

