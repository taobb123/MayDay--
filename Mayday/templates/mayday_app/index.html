{% extends 'mayday_app/base.html' %}

{% block content %}
<div class="container-fluid" data-user-authenticated="{% if user.is_authenticated %}true{% else %}false{% endif %}">
    <!-- 搜索和操作按钮 -->
    <div class="mb-4 d-flex justify-content-between align-items-center">
        <div class="flex-grow-1 me-3">
            <div class="input-group">
                <input type="text" class="form-control" id="searchInput" placeholder="搜索歌曲或作者..." onkeyup="handleSearchKeyup(event)">
                <button class="btn btn-outline-primary" onclick="performSearch()">
                    <i class="bi bi-search"></i> 搜索
                </button>
            </div>
            <div id="searchResults" class="mt-3" style="display: none;">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>搜索结果</span>
                        <button class="btn btn-sm btn-secondary" onclick="closeSearchResults()">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="searchResultsContent"></div>
                    </div>
                </div>
            </div>
            {% if user.is_authenticated %}
            <div class="mt-2">
                <div class="d-flex align-items-center gap-2 flex-wrap">
                    <span><i class="bi bi-music-note-list"></i> 我的歌单：</span>
                    {% if playlists %}
                        {% for playlist in playlists %}
                        <a href="/playlist/{{ playlist.id }}/" class="text-decoration-none">
                            {{ playlist.name }}
                        </a>
                        {% if not forloop.last %}<span class="text-muted">|</span>{% endif %}
                        {% endfor %}
                    {% else %}
                        <a href="{% url 'playlist_list' %}" class="text-decoration-none text-muted">
                            暂无歌单，点击创建
                        </a>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- 选择歌单模态框 -->
        {% if user.is_authenticated %}
        <div class="modal fade" id="selectPlaylistModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">选择歌单</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div id="playlistList" style="max-height: 400px; overflow-y: auto;">
                            <p class="text-muted text-center">加载中...</p>
                        </div>
                        <input type="hidden" id="currentSongIdForPlaylist">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <a href="{% url 'playlist_list' %}" class="btn btn-primary">
                            <i class="bi bi-plus-circle"></i> 创建新歌单
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        <div>
            <button class="btn btn-scan" onclick="scanMusic()">
                <i class="bi bi-folder2-open"></i> 扫描音乐
            </button>
        </div>
    </div>
    
    <!-- 专辑展示 -->
    <div class="mb-5">
        <h2 class="mb-4"><i class="bi bi-vinyl"></i> 专辑</h2>
        <div class="album-grid">
            {% for album in albums %}
            <a href="{% url 'album_detail' album.id %}" class="album-card" style="text-decoration: none; color: inherit; display: block;">
                {% if album.cover_image %}
                <img src="{{ album.cover_image.url }}" alt="{{ album.name }}" class="album-cover">
                {% else %}
                <div class="album-cover d-flex align-items-center justify-content-center text-white">
                    <i class="bi bi-music-note-beamed" style="font-size: 4rem;"></i>
                </div>
                {% endif %}
                <div class="album-info">
                    <h5>{{ album.name }}</h5>
                    <p class="text-muted mb-1">{{ album.release_date|date:"Y年m月d日" }}</p>
                    <small class="text-muted">{{ album.songs.count }} 首歌曲</small>
                </div>
            </a>
            {% empty %}
            <div class="col-12 text-center text-muted">
                <p>暂无专辑，请先扫描音乐文件</p>
            </div>
            {% endfor %}
        </div>
        
        <!-- 分页导航 -->
        {% if albums.has_other_pages %}
        <nav aria-label="专辑分页" class="mt-4">
            <ul class="pagination justify-content-center">
                {% if albums.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?album_page=1{% if songs.number > 1 %}&song_page={{ songs.number }}{% endif %}">&laquo; 首页</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?album_page={{ albums.previous_page_number }}{% if songs.number > 1 %}&song_page={{ songs.number }}{% endif %}">上一页</a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <span class="page-link">&laquo; 首页</span>
                </li>
                <li class="page-item disabled">
                    <span class="page-link">上一页</span>
                </li>
                {% endif %}
                
                <li class="page-item active">
                    <span class="page-link">
                        第 {{ albums.number }} 页，共 {{ albums.paginator.num_pages }} 页
                    </span>
                </li>
                
                {% if albums.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?album_page={{ albums.next_page_number }}{% if songs.number > 1 %}&song_page={{ songs.number }}{% endif %}">下一页</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?album_page={{ albums.paginator.num_pages }}{% if songs.number > 1 %}&song_page={{ songs.number }}{% endif %}">末页 &raquo;</a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <span class="page-link">下一页</span>
                </li>
                <li class="page-item disabled">
                    <span class="page-link">末页 &raquo;</span>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
    
    <!-- 时间线 -->
    <div class="mb-5">
        <h2 class="mb-4"><i class="bi bi-clock-history"></i> 时间隧道</h2>
        <div class="timeline">
            {% for item in timeline_data %}
            <div class="timeline-item {{ item.type }}">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-2">
                            {% if item.type == 'album' %}
                            <i class="bi bi-vinyl-fill text-primary me-2"></i>
                            {% elif item.type == 'tour' %}
                            <i class="bi bi-music-player-fill text-warning me-2"></i>
                            {% elif item.type == 'quote' %}
                            <i class="bi bi-chat-quote-fill text-success me-2"></i>
                            {% elif item.type == 'image' %}
                            <i class="bi bi-image-fill text-danger me-2"></i>
                            {% endif %}
                            <h5 class="mb-0">{{ item.title }}</h5>
                        </div>
                        <p class="text-muted mb-2">
                            <i class="bi bi-calendar3"></i> {{ item.date|date:"Y年m月d日" }}
                        </p>
                        {% if item.type == 'album' and item.content.cover_image %}
                        <img src="{{ item.content.cover_image }}" alt="{{ item.title }}" 
                             class="img-fluid rounded mb-2" style="max-width: 200px;">
                        {% endif %}
                        {% if item.type == 'quote' %}
                        <blockquote class="blockquote">
                            <p>{{ item.content.text }}</p>
                            {% if item.content.author %}
                            <footer class="blockquote-footer">{{ item.content.author }}</footer>
                            {% endif %}
                        </blockquote>
                        {% endif %}
                        {% if item.type == 'image' and item.content.image_url %}
                        <img src="{{ item.content.image_url }}" alt="{{ item.title }}" 
                             class="img-fluid rounded mb-2" style="max-height: 300px;">
                        {% endif %}
                        {% if item.content.description %}
                        <p>{{ item.content.description|truncatewords:30 }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="text-center text-muted">
                <p>时间线为空，请添加内容</p>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- 最近歌曲 -->
    <div class="mb-5">
        <h2 class="mb-4"><i class="bi bi-music-note-list"></i> 歌曲列表</h2>
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>歌曲</th>
                        <th>艺术家</th>
                        <th>专辑</th>
                        <th>时长</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for song in songs %}
                    <tr>
                        <td>{{ songs_start_index|add:forloop.counter0 }}</td>
                        <td>{{ song.title }}</td>
                        <td>{{ song.artist }}</td>
                        <td>{{ song.album.name|default:"-" }}</td>
                        <td>
                            {% if song.duration %}
                            {{ song.duration|floatformat:0 }}秒
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                {% if song.file_path or song.original_path %}
                                <button class="btn btn-sm btn-primary play-song-btn" 
                                        data-play-url="{% url 'play_song' song.id %}"
                                        data-song-title="{{ song.title|escapejs }}"
                                        data-song-artist="{{ song.artist|escapejs }}"
                                        data-song-id="{{ song.id }}">
                                    <i class="bi bi-play-fill"></i> 播放
                                </button>
                                {% endif %}
                                {% if user.is_authenticated %}
                                <button class="btn btn-sm btn-outline-secondary" onclick="showPlaylistModal({{ song.id }})" type="button">
                                    <i class="bi bi-list-ul"></i> 歌单
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center text-muted">暂无歌曲</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- 歌曲分页导航 -->
        {% if songs.has_other_pages %}
        <nav aria-label="歌曲分页" class="mt-4">
            <ul class="pagination justify-content-center">
                {% if songs.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?song_page=1{% if albums.number > 1 %}&album_page={{ albums.number }}{% endif %}">&laquo; 首页</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?song_page={{ songs.previous_page_number }}{% if albums.number > 1 %}&album_page={{ albums.number }}{% endif %}">上一页</a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <span class="page-link">&laquo; 首页</span>
                </li>
                <li class="page-item disabled">
                    <span class="page-link">上一页</span>
                </li>
                {% endif %}
                
                <li class="page-item active">
                    <span class="page-link">
                        第 {{ songs.number }} 页，共 {{ songs.paginator.num_pages }} 页
                    </span>
                </li>
                
                {% if songs.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?song_page={{ songs.next_page_number }}{% if albums.number > 1 %}&album_page={{ albums.number }}{% endif %}">下一页</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?song_page={{ songs.paginator.num_pages }}{% if albums.number > 1 %}&album_page={{ albums.number }}{% endif %}">末页 &raquo;</a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <span class="page-link">下一页</span>
                </li>
                <li class="page-item disabled">
                    <span class="page-link">末页 &raquo;</span>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
</div>

<script>
// 从DOM获取用户认证状态
const container = document.querySelector('.container-fluid');
const USER_AUTHENTICATED = container && container.dataset.userAuthenticated === 'true';
let searchTimeout = null;

// 事件委托：处理播放按钮点击
document.addEventListener('click', function(e) {
    if (e.target.closest('.play-song-btn')) {
        const btn = e.target.closest('.play-song-btn');
        const playUrl = btn.dataset.playUrl;
        const title = btn.dataset.songTitle;
        const artist = btn.dataset.songArtist;
        const songId = parseInt(btn.dataset.songId);
        playSong(playUrl, title, artist, songId);
    }
    
});

function handleSearchKeyup(event) {
    if (event.key === 'Enter') {
        performSearch();
    } else {
        // 防抖：延迟搜索
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            const query = event.target.value.trim();
            if (query.length >= 2) {
                performSearch();
            }
        }, 500);
    }
}

function performSearch() {
    const query = document.getElementById('searchInput').value.trim();
    if (!query) {
        closeSearchResults();
        return;
    }
    
    fetch(`/api/search/?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            const resultsDiv = document.getElementById('searchResults');
            const contentDiv = document.getElementById('searchResultsContent');
            
            if (data.results && data.results.length > 0) {
                let html = '<table class="table table-hover">';
                html += '<thead><tr><th>歌曲</th><th>艺术家</th><th>专辑</th><th>操作</th></tr></thead>';
                html += '<tbody>';
                
                data.results.forEach(song => {
                    const titleEscaped = song.title.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    const artistEscaped = song.artist.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    html += `
                        <tr>
                            <td>${song.title}</td>
                            <td>${song.artist}</td>
                            <td>${song.album_name || '-'}</td>
                            <td>
                                <div class="btn-group" role="group">
                                    <button class="btn btn-sm btn-primary" 
                                            onclick="playSong('/play/${song.id}/', '${titleEscaped}', '${artistEscaped}', ${song.id})">
                                        <i class="bi bi-play-fill"></i> 播放
                                    </button>
                                    ${USER_AUTHENTICATED ? `
                                    <button class="btn btn-sm btn-outline-secondary" onclick="showPlaylistModal(${song.id})">
                                        <i class="bi bi-list-ul"></i> 歌单
                                    </button>
                                    ` : ''}
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                contentDiv.innerHTML = html;
                resultsDiv.style.display = 'block';
            } else {
                contentDiv.innerHTML = '<p class="text-muted text-center">没有找到相关歌曲</p>';
                resultsDiv.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Search error:', error);
            alert('搜索失败');
        });
}

function closeSearchResults() {
    document.getElementById('searchResults').style.display = 'none';
    document.getElementById('searchInput').value = '';
}

// 显示选择歌单模态框
function showPlaylistModal(songId) {
    console.log('showPlaylistModal 被调用，songId:', songId);
    
    // 验证参数
    if (!songId) {
        console.error('showPlaylistModal: songId 未提供');
        alert('歌曲ID未找到');
        return;
    }
    
    const currentSongIdInput = document.getElementById('currentSongIdForPlaylist');
    const playlistList = document.getElementById('playlistList');
    
    if (!currentSongIdInput) {
        console.error('showPlaylistModal: 找不到 currentSongIdForPlaylist 元素');
        alert('页面元素未找到，请刷新页面重试');
        return;
    }
    
    if (!playlistList) {
        console.error('showPlaylistModal: 找不到 playlistList 元素');
        alert('页面元素未找到，请刷新页面重试');
        return;
    }
    
    currentSongIdInput.value = songId;
    playlistList.innerHTML = '<p class="text-muted text-center">加载中...</p>';
    
    // 加载所有歌单 - 使用新的简单API端点
    console.log('开始加载歌单列表...');
    fetch('/api/playlists/list/', {
        method: 'GET',
        headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
        },
        credentials: 'same-origin'
    })
        .then(async response => {
            console.log('歌单列表API响应状态:', response.status);
            console.log('响应头:', response.headers);
            
            // 先读取响应文本
            const text = await response.text();
            console.log('响应内容:', text.substring(0, 500));
            
            // 检查响应类型
            const contentType = response.headers.get('content-type') || '';
            const isJson = contentType.includes('application/json');
            
            if (!response.ok) {
                // 尝试解析错误信息
                if (isJson) {
                    try {
                        const errorData = JSON.parse(text);
                        throw new Error(errorData.error || errorData.detail || `HTTP错误: ${response.status}`);
                    } catch (e) {
                        throw new Error(`HTTP错误: ${response.status}`);
                    }
                } else {
                    // 如果是401或403，可能是认证问题
                    if (response.status === 401 || response.status === 403) {
                        throw new Error('请先登录');
                    }
                    throw new Error(`HTTP错误: ${response.status}`);
                }
            }
            
            if (!isJson) {
                console.error('响应不是JSON格式:', text.substring(0, 500));
                throw new Error('服务器返回了非JSON响应');
            }
            
            return JSON.parse(text);
        })
        .then(data => {
            console.log('收到歌单数据:', data);
            
            // 新的API直接返回数组，不需要处理分页
            let playlists = [];
            if (Array.isArray(data)) {
                playlists = data;
            } else {
                console.error('歌单数据格式错误，期望数组:', data);
                throw new Error('歌单数据格式错误');
            }
            
            console.log('解析后的歌单列表:', playlists);
            
            if (playlists.length === 0) {
                playlistList.innerHTML = `
                    <p class="text-muted text-center">您还没有创建任何歌单</p>
                    <div class="text-center">
                        <a href="{% url 'playlist_list' %}" class="btn btn-primary">
                            <i class="bi bi-plus-circle"></i> 创建歌单
                        </a>
                    </div>
                `;
                // 即使没有歌单，也显示模态框
                const modalElement = document.getElementById('selectPlaylistModal');
                if (modalElement) {
                    const modal = new bootstrap.Modal(modalElement);
                    modal.show();
                } else {
                    console.error('找不到模态框元素 selectPlaylistModal');
                }
                return;
            }
            
            // 创建歌单列表
            let html = '<div class="list-group">';
            playlists.forEach(playlist => {
                html += `
                    <button type="button" class="list-group-item list-group-item-action" 
                            onclick="addSongToPlaylist(${playlist.id}, ${songId})">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">${escapeHtml(playlist.name)}</h6>
                                <small class="text-muted">${playlist.song_count || 0} 首歌曲</small>
                            </div>
                            <i class="bi bi-chevron-right"></i>
                        </div>
                    </button>
                `;
            });
            html += '</div>';
            playlistList.innerHTML = html;
            
            // 显示模态框
            const modalElement = document.getElementById('selectPlaylistModal');
            if (modalElement) {
                const modal = new bootstrap.Modal(modalElement);
                modal.show();
                console.log('模态框已显示');
            } else {
                console.error('找不到模态框元素 selectPlaylistModal');
                alert('无法显示歌单选择框，请刷新页面重试');
            }
        })
        .catch(error => {
            console.error('加载歌单列表失败:', error);
            console.error('错误详情:', error.message, error.stack);
            
            let errorMessage = '加载歌单失败，请重试';
            if (error.message === '请先登录') {
                errorMessage = '请先登录后再添加歌曲到歌单';
            } else if (error.message) {
                errorMessage = error.message;
            }
            
            playlistList.innerHTML = `
                <p class="text-danger text-center">${escapeHtml(errorMessage)}</p>
                <div class="text-center mt-3">
                    <button class="btn btn-sm btn-primary" onclick="showPlaylistModal(${songId})">
                        <i class="bi bi-arrow-clockwise"></i> 重试
                    </button>
                </div>
            `;
            
            // 即使失败也尝试显示模态框
            const modalElement = document.getElementById('selectPlaylistModal');
            if (modalElement) {
                const modal = new bootstrap.Modal(modalElement);
                modal.show();
            }
        });
}

function addSongToPlaylist(playlistId, songId) {
    // 如果没有传入songId，从隐藏字段获取
    if (!songId) {
        songId = document.getElementById('currentSongIdForPlaylist')?.value;
    }
    
    // 验证参数
    if (!playlistId || !songId) {
        console.error('addSongToPlaylist: 缺少必要参数', { playlistId, songId });
        alert('参数错误：歌单ID或歌曲ID缺失');
        return;
    }
    
    // 确保是数字类型
    playlistId = parseInt(playlistId);
    songId = parseInt(songId);
    
    if (isNaN(playlistId) || isNaN(songId)) {
        console.error('addSongToPlaylist: 参数类型错误', { playlistId, songId });
        alert('参数错误：歌单ID或歌曲ID必须是数字');
        return;
    }
    
    const csrfToken = getCookie('csrftoken');
    if (!csrfToken) {
        alert('CSRF token未找到，请刷新页面后重试');
        return;
    }
    
    console.log('添加歌曲到歌单:', { playlistId, songId });
    
    fetch(`/api/playlists/${playlistId}/add_song/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            'X-CSRFToken': csrfToken
        },
        credentials: 'same-origin',
        body: JSON.stringify({ song_id: songId })
    })
    .then(async response => {
        const text = await response.text();
        const contentType = response.headers.get('content-type') || '';
        const isJson = contentType.includes('application/json');
        
        if (!isJson) {
            throw new Error('服务器返回了非JSON响应');
        }
        
        const jsonData = JSON.parse(text);
        
        if (!response.ok) {
            throw new Error(jsonData.error || '添加失败');
        }
        
        return jsonData;
    })
    .then(data => {
        // 关闭模态框
        const modal = bootstrap.Modal.getInstance(document.getElementById('selectPlaylistModal'));
        if (modal) {
            modal.hide();
        }
        // 显示成功消息（可选，静默处理）
        // alert('已添加到歌单');
    })
    .catch(error => {
        console.error('Error:', error);
        alert(error.message || '添加失败');
    });
}

// HTML转义函数
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}

